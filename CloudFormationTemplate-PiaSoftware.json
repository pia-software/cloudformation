{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Mappings": {
        "RegionMap": {
            "ap-northeast-1": {
                "64": "ami-f2b1f394"
            },
            "ap-northeast-2": {
                "64": "ami-cd3c91a3"
            },
            "ap-southeast-1": {
                "64": "ami-0cbce970"
            },
            "ap-southeast-2": {
                "64": "ami-88ff3eea"
            },
            "ap-south-1": {
                "64": "ami-0d336d62"
            },
            "eu-west-1": {
                "64": "ami-e10c4c98"
            },
            "sa-east-1": {
                "64": "ami-5fde9533"
            },
            "us-east-1": {
                "64": "ami-bb4b74c4"
            },
            "us-west-1": {
                "64": "ami-b7ded4d7"
            },
            "us-west-2": {
                "64": "ami-918114e9"
            },
            "eu-central-1": {
                "64": "ami-2cb0df43"
            },
            "us-east-2": {
                "64": "ami-bf093eda"
            },
            "eu-west-2": {
                "64": "ami-e5846382"
            },
            "ca-central-1": {
                "64": "ami-e9b5328d"
            },
            "eu-west-3": {
                "64": "ami-6c66d011"
            }
        }
    },
    "Resources": {
        "FlowLogsViewerIamPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "FlowLogsViewerIamPolicy",
                "Users": [
                    "FlowLogsViewerUser106"
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1441998815000",
                            "Effect": "Allow",
                            "Action": [
                                "ec2:DescribeFlowLogs",
                                "ec2:DescribeNetworkInterfaces",
                                "ec2:DescribeRegions",
                                "ec2:DescribeSecurityGroups",
                                "ec2:DescribeInstances",
                                "ec2:DescribeVpcs",
                                "logs:DescribeLogGroups",
                                "logs:DescribeLogStreams",
                                "logs:GetLogEvents"
                            ],
                            "Resource": [
                                "*"
                            ]
                        }
                    ]
                }
            },
            "DependsOn": [
                "FlowLogsViewerUser106"
            ]
        },
        "FlowLogsViewerUser106": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "UserName": "FlowLogsViewerUser106"
            },
            "DependsOn": []
        },
        "FlowLogViewerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPCID"
                },
                "GroupDescription": "Allow http and https to FlowLogsViewer instance",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "ToPort": "80",
                        "FromPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": {
                            "Ref": "myIPCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": {
                            "Ref": "myIPCIDR"
                        }
                    }
                ]
            },
        },
        "FlowLogsViewerUser106AccessKey": {
            "Properties": {
                "UserName": "FlowLogsViewerUser106"
            },
            "Type": "AWS::IAM::AccessKey",
            "DependsOn": [
                "FlowLogsViewerUser106"
            ]
        },
        "FlowLogsViewerInstance106": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": {
                    "Ref": "myInstanceType"
                },
                "SecurityGroupIds" : [{ "Ref" : "FlowLogViewerSecurityGroup" }],
                "SubnetId": {
                    "Ref": "mySubnetID"
                },
                "KeyName": {
                    "Ref": "myKeyPair"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "64"
                    ]
                }
            },
            "DependsOn": [
                "FlowLogViewerSecurityGroup"
            ]
        }
    },
    "Parameters": {
        "myKeyPair": {
            "Description": "Amazon EC2 Key Pair",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "myIPCIDR": {
            "Description": "CIDR block for inbound security group ALLOW to viewer. ex 192.168.1.1/32",
            "Type": "String"
        },
        "myVPCID": {
            "Description": "The VPC to launch the viewer into",
            "Type": "AWS::EC2::VPC::Id"
        },
        "mySubnetID": {
            "Description": "The Subnet to launch the viewer into",
            "Type": "AWS::EC2::Subnet::Id"
        },
        "myInstanceType": {
            "Description": "Choose an instance type. t2.micro is recommended.",
            "Type" : "String",
            "Default" : "t2.micro",
            "AllowedValues" : [ "t2.nano", "t2.micro", "t2.small", "t2.medium", "t2.large", "c4.large", "c5.large",
                "m5.large", "r4.large", "c3.large", "i3.large", "m3.medium", "m3.large", "m4.large", "r3.large"],
            "ConstraintDescription" : "must be a valid EC2 instance type."
        }
    }
}

